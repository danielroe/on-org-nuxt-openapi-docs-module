<template>
  <div class="oapi-layout">
    <OpenApiMainHeader :isMenuOpen="isMenuOpen" @toggleMenu="toggleMenu">
      <template #logo>
        <nuxt-link to="/" :active-class="''">
          <span v-html="logo"></span>
        </nuxt-link>
      </template>
      <template #button>
        <OpenApiHeader
          :current-locale="currentLocale"
          :files="files"
          :locales="locales"
          :file="file"
          :path="path_doc"
          :is-dark-mode="isDarkMode"
          @toggleDarkMode="toggleDarkMode"
        />
      </template>
    </OpenApiMainHeader>
    <div class="oapi-layout__body">
      <OpenApiMainLeftMenu :isMenuOpen="isMenuOpen" :isMobile="isMobile">
        <OpenApiMenu :routes="pathsByTags" :current-locale="currentLocale" :file="file" :path="path_doc" :files="files" :locales="locales" />
      </OpenApiMainLeftMenu>

      <OpenApiMainContent>
        <transition name="oapi-fade" tag="div">
          <% if (options.isNuxt2) {print('<Nuxt />');} %>
          <% if (options.isNuxt3) {print(' <div><slot></slot></div>');} %>
        </transition>
        <template #footer>
          <footer class="oapi-footer" v-if="footer" v-html="footer"></footer>
        </template>
      </OpenApiMainContent>
    </div>
  </div>
</template>

<script lang="ts">
<% if (options.isNuxt3) {
  print('import {useNuxtApp, showError, useRoute, useHead} from "#app";');
} %>


const isNuxt3 = <%= options.isNuxt3 %>;
const isNuxt2 = <%= options.isNuxt2 %>;

function genHead() {
  return {
    htmlAttrs: { class: 'oapi' }
  }
}

export default {
  name: 'openapi-docs',
  setup() {
    if(isNuxt3) {
      const file = '<%= options.fileName %>';
      const { $openapidoc } = useNuxtApp()
      useHead(genHead());
      if(!$openapidoc.hasAccess(file)) {
        showError({
          statusCode: 404,
          message: 'page not found',
        })
      }
      const route = useRoute()
      return {
        currentLocale: route.params.locale ?? route.meta.locale ?? 'en',
      }
    }
  },
  async fetch() {
    try {
      if(!this.$openapidoc.hasAccess(this.file)) {
        this.$nuxt.context.error({ status: 404, message: 'page not found' });
      }
      const ctx = this.$nuxt.context
      this.currentLocale = ctx.route.params.locale ?? ctx.route.meta[0].locale ?? 'en';
    } catch (e) {
      console.error(e)
    }
  },
  created() {
    if(this && this.$fetch) this.$fetch();
  },
  watch: {
    '$route.meta': {
      handler: function(val) {
        if(val.locale) {
          this.currentLocale = val.locale;
        }
      },
      deep: true
    },
    '$route': {
      handler: function(val) {
        if (this.isMobile) {
          this.isMenuOpen = false;
        }
      },
      deep: true
    },
  },
  data() {
    return {
      pathsByTags: <%= JSON.stringify(options.pathsByTags) %>,
      files: <%= JSON.stringify(options.files) %>,
      path_doc: '<%= options.path %>',
      locales: <%= JSON.stringify(options.locales) %>,
      name: '<%= options.name %>',
      isMenuOpen: true,
      isMobile: false,
      currentLocale: 'en',
      file: '<%= options.fileName %>',
      isDarkMode: false,
    };
  },
  head() {
    return genHead();
  },
  computed: {
    footer() {
      return this.$openapidoc.getFooter()
    },
    logo() {
      return this.$openapidoc.getLogo().replace(':name', this.name)
    },
    isVue2(){
      return isNuxt2
    },
    isVue3(){
      return isNuxt3
    }
  },
  methods: {
    foo(val: string) {
      console.log(val.toUpperCase());
    },
    toggleMenu() {
      this.isMenuOpen = !this.isMenuOpen;
    },
    toggleDarkMode() {
      if(process.client) {
        this.isDarkMode = !this.isDarkMode
        localStorage.setItem('isDarkMode', this.isDarkMode)
        if(this.isDarkMode) document.querySelector('html').classList.add('dark')
        else document.querySelector('html').classList.remove('dark');
      }
    },
    handleResize() {
      this.isDesktop = window.innerWidth >= 1110;
      this.isMobile = window.innerWidth < 1110;
      if (!this.isDesktop && this.isMenuOpen) {
        this.isMenuOpen = false
      }
      if (this.isDesktop) {
        this.isMenuOpen = true
      }
    },
  },
  mounted() {
    if(process.client) {
      this.isMobile = window.innerWidth < 1110;
      this.isMenuOpen = window.innerWidth >= 1110;
      window.addEventListener('resize', this.handleResize)
      this.isDarkMode = localStorage.getItem('isDarkMode') === 'true'
      if(this.isDarkMode) document.querySelector('html').classList.add('dark')
    }
    this.$nextTick(() => {
      this.foo('foobar');
    });

  },
  unmounted() {
    window.removeEventListener('resize', this.handleResize)
  },
  beforeDestroy() {
    window.removeEventListener('resize', this.handleResize)
  },
}
</script>

<style lang="scss">

.oapi-layout {
  display: flex;
  flex-direction: column;
  height: 100vh;
  &__body {
    display: flex;
    overflow: hidden;
    flex: 1 1 0;
    position: relative;
  }
}

.oapi {
  blockquote {
    font-style: italic;
    margin-left: 20px;
    padding-left: 10px;
    border-left: 5px solid #ccc;
  }

  .doc-info a {
    color: #4299e1;
    text-decoration: none;
    border-bottom: 1px solid #4299e1;
  }

  .doc-info a:hover {
      color: #2c5282;
      border-bottom: 1px solid #2c5282;
  }

  .doc-info img {
    max-width: 100%;
    margin: 1.5rem 0;
  }
}

.oapi-fade-enter-active, .oapi-fade-leave-active {
  transition: opacity .3s;
}
.oapi-fade-enter, .oapi-fade-leave-to {
  opacity: 0;
}
.oapi-footer {
  border-top: 1px solid #e2e2e2;
  padding: 8px 0;
  font-size: 0.875rem;
}
</style>
